{% extends 'base.html' %}
{% block title %}Facebook Campaigns{% endblock %}

{% block extra_css %}
<style>
	/* Responsive table */
	.table-responsive {
		overflow-x: auto;
	}

	/* Điều chỉnh giao diện trên màn hình nhỏ */
	@media (max-width: 992px) {
		h2 {
			font-size: 24px;
			text-align: center;
		}

		.form-group {
			flex-direction: column;
			align-items: stretch;
		}

		.filter-btn {
			margin-top: 10px;
			width: 100%;
			justify-content: center;
		}

		.table th,
		.table td {
			font-size: 14px;
			padding: 8px;
			white-space: nowrap;
			/* Tránh bị vỡ dòng */
		}
	}

	@media (max-width: 576px) {
		h2 {
			font-size: 22px;
		}

		.table th,
		.table td {
			font-size: 12px;
			padding: 6px;
		}

		.btn {
			width: 100%;
			margin-bottom: 5px;
		}
	}
</style>
{% endblock %}

{% block content %}
<h2 class="my-4 text-primary text-center">
	<i class="fab fa-facebook-square"></i> Facebook Campaigns
</h2>

<!-- Form lọc chiến dịch theo tài khoản quảng cáo -->
<form method="GET" action="{{ url_for('ads_manager.list_fb_campaigns') }}" class="mb-3">
	{{ form.csrf_token }}
	<label for="ad_account_filter" class="form-label fw-bold">
		<i class="fas fa-filter"></i> Filter by Ads Account
	</label>
	<div class="row g-2">
		<div class="col-12 col-md-8">
			<select name="ad_account_filter" id="ad_account_filter" class="form-control">
				<option value="">All Accounts</option>
				{% for account in facebook_ad_accounts %}
				<option value="{{ account.id }}" {% if request.args.get('ad_account_filter')==account.id|string %}selected{% endif %}>
					{{ account.name }}
				</option>
				{% endfor %}
			</select>
		</div>
		<div class="col-12 col-md-4">
			<button type="submit" class="btn btn-primary w-100">
				<i class="fas fa-search me-2"></i> Filter
			</button>
		</div>
	</div>
</form>

<!-- Button Actions -->
<div class="row g-2 mb-3">
	<div class="col-12 col-md-6">
		<form method="POST" action="{{ url_for('ads_manager.sync_campaigns') }}">
			{{ form.csrf_token }}
			<button type="submit" id="sync-fb-button" class="btn btn-success w-100">
				<i class="fas fa-sync-alt me-2"></i> Sync Facebook Campaigns
			</button>
		</form>
	</div>
	<div class="col-12 col-md-6">
		<a href="{{ url_for('ads_manager.create_fb_campaign') }}" class="btn btn-info w-100">
			<i class="fas fa-plus-circle me-2"></i> Create New Campaign
		</a>
	</div>
</div>

<form method="POST" action="{{ url_for('ads_manager.delete_selected_campaigns') }}">
	{{ form.csrf_token }}
	<button type="submit" class="btn btn-danger mb-3 w-100">
		<i class="fas fa-trash-alt me-2"></i> Delete Selected
	</button>

	<!-- Bảng Chiến Dịch -->
	{% if campaigns %}
	<div class="table-responsive">
		<table class="table table-bordered table-striped">
			<thead class="table-dark">
				<tr>
					<th scope="col"><input type="checkbox" id="select_all" onclick="selectAll()"></th>
					<th scope="col">Campaign ID</th>
					<th class="text-start" scope="col">Name</th>
					<th scope="col">Objective</th>
					<th scope="col">Status</th>
					<th scope="col">Created Time</th>
					<th scope="col">Start Time</th>
					<th scope="col">End Time</th>
					<th scope="col">Special Ad Categories</th>
				</tr>
			</thead>
			<tbody>
				{% for campaign in campaigns %}
				<tr>
					<td><input type="checkbox" name="selected_campaigns" value="{{ campaign.facebook_campaign_id }}"></td>
					<td class="fw-bold text-primary">{{ campaign.facebook_campaign_id }}</td>
					<td class="text-start">{{ campaign.name }}</td>
					<td>{{ campaign.objective }}</td>
					<td>
						<span class="badge {% if campaign.status == 'ACTIVE' %}bg-success{% else %}bg-secondary{% endif %}">
							{{ campaign.status }}
						</span>
					</td>
					<td>{{ campaign.created_time }}</td>
					<td>{{ campaign.start_time if campaign.start_time else 'N/A' }}</td>
					<td>{{ campaign.end_time if campaign.end_time else 'N/A' }}</td>
					<td>{{ campaign.special_ad_categories if campaign.special_ad_categories else 'None' }}</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	{% else %}
	<p class="text-muted text-center">No campaigns found.</p>
	{% endif %}
</form>

{% if pagination.pages > 1 %}
<nav aria-label="Campaign list pagination" class="mt-3">
	<ul class="pagination justify-content-center">
		{% if pagination.has_prev %}
		<li class="page-item">
			<a class="page-link"
				href="{{ url_for('ads_manager.list_fb_campaigns', page=pagination.prev_num, ad_account_filter=request.args.get('ad_account_filter')) }}">Previous</a>
		</li>
		{% endif %}

		{% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
		{% if page_num %}
		{% if page_num == pagination.page %}
		<li class="page-item active">
			<span class="page-link">{{ page_num }}</span>
		</li>
		{% else %}
		<li class="page-item">
			<a class="page-link"
				href="{{ url_for('ads_manager.list_fb_campaigns', page=page_num, ad_account_filter=request.args.get('ad_account_filter')) }}">{{ page_num }}</a>
		</li>
		{% endif %}
		{% else %}
		<li class="page-item disabled">
			<span class="page-link">...</span>
		</li>
		{% endif %}
		{% endfor %}

		{% if pagination.has_next %}
		<li class="page-item">
			<a class="page-link"
				href="{{ url_for('ads_manager.list_fb_campaigns', page=pagination.next_num, ad_account_filter=request.args.get('ad_account_filter')) }}">Next</a>
		</li>
		{% endif %}
	</ul>
</nav>
{% endif %}

<script>
	function selectAll() {
		const checkboxes = document.querySelectorAll('input[name="selected_campaigns"]');
		const selectAllCheckbox = document.getElementById('select_all');
		checkboxes.forEach(checkbox => {
			checkbox.checked = selectAllCheckbox.checked;
		});
	}
</script>
{% endblock %}
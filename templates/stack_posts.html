<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Post List</title>
		<link rel="icon" type="image/svg+xml"
			href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%234267B2'/><text x='50%' y='70%' font-size='70' fill='white' text-anchor='middle' font-family='Arial'>{{ app_name[0]|upper }}</text></svg>">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	</head>
	<body>
		{% include 'header.html' %}
		{% include 'message.html' %}

		<div class="container mt-5">
			<h1 class="text-center mb-4">Post List</h1>
			{% if page_id or status %}
			<div class="alert alert-info">
				Filter:
				{% if page_id %}
				Page: {{ pages|selectattr("page_id", "equalto", page_id)|map(attribute="name")|first }}
				{% endif %}
				{% if status %}
				, Status: {{ status }}
				{% endif %}
			</div>
			{% endif %}

			<!-- Filter form by page and status -->
			<form method="GET" id="filter_record" action="{{ url_for('stack_post.index') }}">
				<div class="row mb-4">
					<!-- Filter by Page -->
					<div class="col-md-4">
						<label for="page_id" class="form-label">Select Page</label>
						<select name="page_id" id="page_id" class="form-select">
							<option value="">All pages</option>
							{% for page in pages %}
							<option value="{{ page.page_id }}" {% if page.page_id|string == page_id %} selected {% endif %}>
								{{ page.name }}
							</option>
							{% endfor %}
						</select>
					</div>

					<!-- Filter by Status -->
					<div class="col-md-4">
						<label for="status" class="form-label">Select Status</label>
						<select name="status" id="status" class="form-select">
							<option value="">All statuses</option>
							<option value="waiting" {% if status == 'waiting' %} selected {% endif %}>Waiting</option>
							<option value="processing" {% if status == 'processing' %} selected {% endif %}>Processing</option>
							<option value="posted" {% if status == 'posted' %} selected {% endif %}>Posted</option>
							<option value="error" {% if status == 'error' %} selected {% endif %}>Error</option>
						</select>
					</div>

					<!-- Filter Button -->
					<div class="col-md-4 d-flex align-items-end">
						<button type="submit" form="filter_record" class="btn btn-primary">Filter</button>
					</div>
				</div>
			</form>

			<!-- Post list table -->
			<form method="POST" id="delete-form" action="{{ url_for('stack_post.delete_selected') }}">
				{{ form.csrf_token }}
				<button type="submit" form="delete-form" class="btn btn-danger mb-3">Delete Selected</button>
				<table class="table table-bordered table-striped">
					<thead class="table-light">
						<tr>
							<th><input type="checkbox" id="select-all" /></th>
							<th>Title</th>
							<th>Page</th>
							<th>Time</th>
							<th>Status</th>
							<th>Action</th>
						</tr>
					</thead>
					<tbody>
						<form></form>
						{% for post in stack_posts %}
						<tr>
							<td>
								<input type="checkbox" name="selected_posts[]" value="{{ post.id }}" class="select-checkbox" />
							</td>
							<td>{{ post.title }}</td>
							<td>{{ post.page.name }}</td>
							<td>{{ post.time }}</td>
							<td>
								<span
									class="badge {% if post.status == 'waiting' %}bg-warning{% endif %}{% if post.status == 'processing' %}bg-info{% endif %}{% if post.status == 'posted' %}bg-success{% endif %}{% if post.status == 'error' %}bg-danger{% endif %}">
									{{ post.status }}
								</span>
							</td>
							<td>
								{% if loop.index0 == 0 %}
								<!-- First post ID: {{ post.id }} -->
								<!-- First post status: {{ post.status }} -->
								{% endif %}
								{% if post.status != 'posted' %}
								<form id="post_form_request_{{ post.id }}" method="POST"
									action="{{ url_for('stack_post.post_video', post_id=post.id) }}" class="d-inline">
									{{ form.csrf_token }}
									<button form="post_form_request_{{ post.id }}" type="submit" class="btn btn-primary btn-sm">
										Post Video
									</button>
								</form>
								{% endif %}
							</td>
						</tr>
						{% else %}
						<tr>
							<td colspan="6" class="text-center">No posts available.</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</form>
		</div>

		<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script> -->
		<script>
			// Script to select all checkboxes
			document.getElementById('select-all').addEventListener('click', function (e) {
				const checkboxes = document.querySelectorAll('input[name="selected_posts[]"]');
				checkboxes.forEach(checkbox => {
					checkbox.checked = e.target.checked;
				});
			});
		</script>
	</body>
</html>